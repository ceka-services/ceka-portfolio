<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>الحجوزات</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; background: #f8f9fa; }
    .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .logout-btn { position: absolute; top: 20px; left: 20px; }
    .delete-btn { font-size: 0.85rem; padding: 4px 8px; }
  </style>
</head>
<body>

<button class="btn btn-outline-danger logout-btn" onclick="logout()">تسجيل خروج</button>

<div class="container">
  <h2 class="text-center mb-4">جميع الحجوزات</h2>
  <div id="bookings-list">
    <p class="text-center">جارٍ التحميل...</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const _supabase = window.supabase.createClient(
    'https://hsvxveceqqjubnfqywlh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzdnh2ZWNlcXFqdWJuZnF5d2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDA1ODEsImV4cCI6MjA3NjgxNjU4MX0.AIzcwu_KmwSz4FUkxRgesvPmBsu-6x3EIEfZDxl7ADc'
  );

  async function loadBookings() {
    try {
      const { data: { user }, error: authError } = await _supabase.auth.getUser();
      
      if (authError || !user) {
        document.getElementById('bookings-list').innerHTML = `
          <div class="alert alert-warning text-center">
            <p>لم يتم تسجيل دخولك.</p>
            <a href="admin.html" class="btn btn-primary">الذهاب إلى صفحة الدخول</a>
          </div>
        `;
        return;
      }

      const { data, error } = await _supabase
        .from('bookings')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('bookings-list').innerHTML = `
          <div class="alert alert-danger text-center">
            <p>خطأ في قاعدة البيانات:</p>
            <small>${error.message}</small>
          </div>
        `;
        console.error('Supabase Error:', error);
        return;
      }

      if (!data || data.length === 0) {
        document.getElementById('bookings-list').innerHTML = '<p class="text-center">لا توجد حجوزات.</p>';
        return;
      }

      let html = '';
      data.forEach(b => {
        html += `
          <div class="card mb-3" data-id="${b.id}">
            <div class="card-body">
              <h5 class="card-title">${b.first_name} ${b.last_name}</h5>
              <p class="card-text"><strong>الاتصال:</strong> ${b.contact_info}</p>
              <p class="card-text">${b.message || 'لا توجد رسالة'}</p>
              <h6 class="text-muted">${new Date(b.created_at).toLocaleDateString('ar-EG')}</h6> </br>
              <button class="btn btn-sm btn-danger delete-btn float-end" onclick="deleteBooking('${b.id}')">
                حذف
              </button>
            </div>
          </div>
        `;
      });

      document.getElementById('bookings-list').innerHTML = html;

    } catch (err) {
      console.error('خطأ عام:', err);
      document.getElementById('bookings-list').innerHTML = `
        <div class="alert alert-danger text-center">
          <p>حدث خطأ غير متوقع.</p>
          <small>${err.message}</small>
        </div>
      `;
    }
  }

  window.deleteBooking = async function(id) {
    if (!confirm('هل أنت متأكد؟ لا يمكن التراجع.')) return;

    const { error } = await _supabase.from('bookings').delete().eq('id', id);

    if (error) {
      alert('فشل الحذف: ' + error.message);
    } else {
      document.querySelector(`[data-id="${id}"]`).remove();
    }
  };

  window.logout = async function() {
    await _supabase.auth.signOut();
    window.location.href = 'admin.html';
  };

  window.addEventListener('load', loadBookings);
</script>
</body>
</html>
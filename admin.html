<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة إدارة المشاريع</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; background: #f8f9fa; }
    .form-container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .logout-btn {
      position: absolute;
      top: 20px;
      left: 20px;
    }
  </style>
</head>
<body>

  <button id="logoutBtn" class="btn btn-outline-danger logout-btn" style="display:none;" onclick="logout()">
    تسجيل خروج
  </button>

  <div class="container mt-5" id="auth-container">
    <div class="form-container text-center">
      <h3>🔐 تسجيل الدخول لإدارة المشاريع</h3>
      <p class="text-muted mb-3">أدخل بريدك الإلكتروني لتلقي رابط دخول آمن</p>
      <input type="email" id="email" class="form-control mb-2" placeholder="example@domain.com" dir="ltr" />
      <button id="login-btn" class="btn btn-primary w-100">إرسال رابط الدخول</button>
      <div id="auth-message" class="mt-2"></div>
    </div>
  </div>

  <div id="admin-form" style="display:none;">
    <div class="form-container">
      <h2 class="text-center mb-4">إضافة مشروع جديد</h2>
      <form id="projectForm">
        <div class="mb-3">
          <label class="form-label">اسم المشروع</label>
          <input type="text" class="form-control" id="title" required>
        </div>
        <div class="mb-3">
          <label class="form-label">الفئة</label>
          <select class="form-control" id="category" required>
            <option value="">اختر الفئة</option>
            <option value="ويب">ويب</option>
            <option value="تطبيقات">تطبيقات</option>
            <option value="أمن">أمن</option>
            <option value="شبكات">شبكات</option>
            <option value="أخرى">أخرى</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">الوصف</label>
          <textarea class="form-control" id="description" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">رابط الموقع الحي (اختياري)</label>
          <input type="url" class="form-control" id="live_url" dir="ltr">
        </div>
        <div class="mb-3">
          <label class="form-label">صورة المشروع</label>
          <input type="file" class="form-control" id="image" accept="image/*" required>
          <div class="form-text">يجب أن تكون الصورة بتنسيق JPG أو PNG</div>
        </div>
        <button type="submit" class="btn btn-primary w-100">إضافة المشروع</button>
      </form>
      <div id="message" class="mt-3 text-center"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://hsvxveceqqjubnfqywlh.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzdnh2ZWNlcXFqdWJuZnF5d2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDA1ODEsImV4cCI6MjA3NjgxNjU4MX0.AIzcwu_KmwSz4FUkxRgesvPmBsu-6x3EIEfZDxl7ADc';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const authContainer = document.getElementById('auth-container');
    const adminForm = document.getElementById('admin-form');
    const logoutBtn = document.getElementById('logoutBtn');
    const messageEl = document.getElementById('message');
    const authMessage = document.getElementById('auth-message');

    async function checkUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        authContainer.style.display = 'none';
        adminForm.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        console.log('المستخدم مسجل دخوله:', user.email);
      } else {
        authContainer.style.display = 'block';
        adminForm.style.display = 'none';
        logoutBtn.style.display = 'none';
      }
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    if (!email || !email.includes('@')) {
        authMessage.innerHTML = '<div class="text-danger">الرجاء إدخال بريد إلكتروني صحيح</div>';
        return;
    }

    authMessage.innerHTML = '<div class="text-info">جاري الإرسال...</div>';
    
    const { error } = await supabase.auth.signInWithOtp({
        email: email,
        options: {
        emailRedirectTo: 'https://ceka-portfolio.pages.dev/admin' // 
        }
    });
    
    if (error) {
        authMessage.innerHTML = `<div class="text-danger">خطأ: ${error.message}</div>`;
    } else {
        authMessage.innerHTML = '<div class="text-success">تم إرسال رابط الدخول! تحقق من بريدك.</div>';
        document.getElementById('email').value = '';
    }
    });

    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      messageEl.innerHTML = '<div class="alert alert-info">جاري الرفع...</div>';

      const file = document.getElementById('image').files[0];
      if (!file) {
        messageEl.innerHTML = '<div class="alert alert-danger">يرجى اختيار صورة</div>';
        return;
      }

      const fileName = `${Date.now()}_${file.name}`;
      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from('projects')
        .upload(`public/${fileName}`, file);

      if (uploadError) {
        console.error('فشل رفع الصورة:', uploadError);
        messageEl.innerHTML = '<div class="alert alert-danger">فشل رفع الصورة</div>';
        return;
      }

      const projectData = {
        title: document.getElementById('title').value.trim(),
        category: document.getElementById('category').value.trim(),
        description: document.getElementById('description').value.trim(),
        live_url: document.getElementById('live_url').value.trim() || null,
        image_path: `public/${fileName}`
      };

      const { error } = await supabase.from('projects').insert([projectData]);
      if (error) {
        console.error('فشل إضافة المشروع:', error);
        messageEl.innerHTML = '<div class="alert alert-danger">فشل إضافة المشروع</div>';
      } else {
        messageEl.innerHTML = '<div class="alert alert-success">تمت إضافة المشروع بنجاح!</div>';
        document.getElementById('projectForm').reset();
      }
    });

    checkUser();
  </script>

  <script>
    async function logout() {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
      const supabase = createClient(
        'https://hsvxveceqqjubnfqywlh.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzdnh2ZWNlcXFqdWJuZnF5d2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDA1ODEsImV4cCI6MjA3NjgxNjU4MX0.AIzcwu_KmwSz4FUkxRgesvPmBsu-6x3EIEfZDxl7ADc'
      );
      await supabase.auth.signOut();
      location.reload();
    }
  </script>
</body>
</html>
